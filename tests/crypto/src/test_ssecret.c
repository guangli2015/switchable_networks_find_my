/*
 * Copyright (c) 2021 Nordic Semiconductor ASA
 *
 * SPDX-License-Identifier: LicenseRef-Nordic-4-Clause
 */

#include <zephyr/ztest.h>

#include "fm_crypto.h"

/* Python: os.urandom(32) */
static const byte SEED_S[32] = {
	0x00, 0x6b, 0x03, 0xeb, 0xf6, 0xeb, 0x78, 0xc4,
	0x2b, 0x3a, 0x5e, 0x69, 0x74, 0xd1, 0x60, 0xa7,
	0x7b, 0x6f, 0x3f, 0xa7, 0x00, 0xd3, 0x1e, 0xcb,
	0x87, 0x43, 0xa2, 0xa4, 0xa5, 0x2a, 0xfc, 0xcc
};

/* Python: os.urandom(32) */
static const byte SEED_K1[32] = {
	0x45, 0xc9, 0xec, 0xf9, 0xa9, 0xf8, 0x40, 0x8e,
	0xd0, 0xbd, 0x6f, 0xd4, 0x03, 0x7e, 0xaf, 0x2f,
	0xb6, 0x7f, 0xbe, 0x3f, 0x31, 0xe7, 0x4e, 0xa9,
	0x79, 0x35, 0x8e, 0x74, 0x06, 0x92, 0x57, 0x36
};

/*
 * [Python]
 * >>> import hashlib
 * >>> m = hashlib.sha256()
 * >>> m.update("006b03ebf6eb78c42b3a5e6974d160a77b6f3fa700d31ecb8743a2a4a52afccc".decode("hex"))
 * >>> m.update("45c9ecf9a9f8408ed0bd6fd4037eaf2fb67fbe3f31e74ea979358e7406925736".decode("hex"))
 * >>> m.update("00000001".decode("hex"))
 * >>> m.update(b"ServerSharedSecret")
 * >>> m.hexdigest()
 * '18fba2c25cb5ea275d4bb093ea43e226e7312503029b8e93c056456bfd0a14d8'
 */
static const byte SERVER_SS[32] = {
	0x18, 0xfb, 0xa2, 0xc2, 0x5c, 0xb5, 0xea, 0x27,
	0x5d, 0x4b, 0xb0, 0x93, 0xea, 0x43, 0xe2, 0x26,
	0xe7, 0x31, 0x25, 0x03, 0x02, 0x9b, 0x8e, 0x93,
	0xc0, 0x56, 0x45, 0x6b, 0xfd, 0x0a, 0x14, 0xd8
};

static const byte msg[] = "sample";

/*
 * [Python]
 * >>> import hmac
 * >>> import hashlib
 * >>> ksn = "97167391b02522241964ef10804173926185f6712578ef797244683b93257a8b".decode("hex")
 * >>> h = hmac.new(ksn, b"sample", digestmod=hashlib.sha256)
 * >>> h.hexdigest()
 * '9943dafac34711542a7a58dfa219a8f08648749b0ea804b22b348d93b35a2332'
 */
static const byte MAC[32] = {
	0x99, 0x43, 0xda, 0xfa, 0xc3, 0x47, 0x11, 0x54,
	0x2a, 0x7a, 0x58, 0xdf, 0xa2, 0x19, 0xa8, 0xf0,
	0x86, 0x48, 0x74, 0x9b, 0x0e, 0xa8, 0x04, 0xb2,
	0x2b, 0x34, 0x8d, 0x93, 0xb3, 0x5a, 0x23, 0x32
};

ZTEST(suite_fmn_crypto, test_ssecret)
{
	byte serverss[32];
	zassert_equal(fm_crypto_derive_server_shared_secret(SEED_S, SEED_K1, serverss), 0, "");
	zassert_equal(memcmp(serverss, SERVER_SS, sizeof(SERVER_SS)), 0, "");

	byte mac[32];
	zassert_equal(fm_crypto_authenticate_with_ksn(serverss, sizeof(msg) - 1, msg, mac), 0, "");
	zassert_equal(memcmp(mac, MAC, sizeof(MAC)), 0, "");

	/* Test SeedK1 generation. */
	byte seedk1[32] = { 0 };
	zassert_equal(fm_crypto_generate_seedk1(seedk1), 0, "");

	byte acc = 0;
	for (int i = 0; i < sizeof(seedk1); acc |= seedk1[i++]);
	zassert_not_equal(acc, 0, "");
}
